(window.webpackJsonp=window.webpackJsonp||[]).push([[258],{940:function(s,n,e){"use strict";e.r(n);var a=e(3),t=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("blockquote",[n("p",[s._v("openvpn 本身支持tcp和udp两种协议\n如果要使用端口映射 必须使用tcp协议")])]),s._v(" "),n("h1",{attrs:{id:"_1-安装前准备"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装前准备"}},[s._v("#")]),s._v(" 1. 安装前准备")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 安装openssl和lzo，lzo用于压缩通讯数据加快传输速度\napt-get install openssl libssl-dev\napt-get install lzop\n# 安装openvpn和easy-rsa\nsudo apt-get install openvpn\nsudo apt-get install easy-rsa\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h1",{attrs:{id:"_2-安装及配置openvpn和easy-rsa"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-安装及配置openvpn和easy-rsa"}},[s._v("#")]),s._v(" 2. 安装及配置OpenVPN和easy-rsa")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 修改vars文件 \nsudo su\ncd /usr/share/easy-rsa/ \nvim vars\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# 修改注册信息，比如公司地址、公司名称、部门名称等。\nexport KEY_COUNTRY="CN"\nexport KEY_PROVINCE="Shandong"\nexport KEY_CITY="Qingdao"\nexport KEY_ORG="MyOrganization"\nexport KEY_EMAIL="me@myhost.mydomain"\nexport KEY_OU="MyOrganizationalUnit"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 初始化环境变量\nsource vars\n \n# 清除keys目录下所有与证书相关的文件\n# 下面步骤生成的证书和密钥都在/usr/share/easy-rsa/keys目录里\n./clean-all\n \n# 生成根证书ca.crt和根密钥ca.key（一路按回车即可）\n./build-ca\n \n# 为服务端生成证书和私钥（一路按回车，直到提示需要输入y/n时，输入y再按回车，一共两次）\n./build-key-server server\n \n# 每一个登陆的VPN客户端需要有一个证书，每个证书在同一时刻只能供一个客户端连接，下面建立2份\n# 为客户端生成证书和私钥（一路按回车，直到提示需要输入y/n时，输入y再按回车，一共两次）\n./build-key client1\n./build-key client2\n \n# 创建迪菲·赫尔曼密钥，会生成dh2048.pem文件（生成过程比较慢，在此期间不要去中断它）\n./build-dh\n \n# 生成ta.key文件（防DDos攻击、UDP淹没等恶意攻击）\nopenvpn --genkey --secret keys/ta.key\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br")])]),n("h1",{attrs:{id:"_3-创建服务器端配置文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-创建服务器端配置文件"}},[s._v("#")]),s._v(" 3. 创建服务器端配置文件")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 在openvpn的配置目录下新建一个keys目录\nmkdir /etc/openvpn/keys\n \n# 将需要用到的openvpn证书和密钥复制一份到刚创建好的keys目录中\ncp /usr/share/easy-rsa/keys/{ca.crt,server.{crt,key},dh2048.pem,ta.key} /etc/openvpn/keys/\n \n# 复制一份服务器端配置文件模板server.conf到/etc/openvpn/\ngzip -d /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz\ncp /usr/share/doc/openvpn/examples/sample-config-files/server.conf /etc/openvpn/\n\n# 查看server.conf里的配置参数\ngrep '^[^#;]' /etc/openvpn/server.conf\n\n# 编辑server.conf\nvim /etc/openvpn/server.conf \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('port 1194\n# 改成tcp，默认使用udp，如果使用HTTP Proxy，必须使用tcp协议\nproto tcp\ndev tun # 路由模式，桥接模式用dev tap\n# 路径前面加keys，全路径为/etc/openvpn/keys/ca.crt\nca keys/ca.crt\ncert keys/server.crt\nkey keys/server.key  # This file should be kept secret\ndh keys/dh2048.pem\n# 默认虚拟局域网网段，不要和实际的局域网冲突即可\nserver 10.8.0.0 255.255.255.0 # 路由模式，桥接模式用server-bridge\nifconfig-pool-persist ipp.txt\n# 10.0.0.0/8是我这台VPN服务器所在的内网的网段，读者应该根据自身实际情况进行修改\npush "route 10.0.0.0 255.0.0.0"\n# 可以让客户端之间相互访问直接通过openvpn程序转发，根据需要设置\nclient-to-client\n# 如果客户端都使用相同的证书和密钥连接VPN，一定要打开这个选项，否则每个证书只允许一个人连接VPN\nduplicate-cn\nkeepalive 10 120\ntls-auth keys/ta.key 0 # This file is secret\ncomp-lzo\npersist-key\npersist-tun\n# OpenVPN的状态日志，默认为/etc/openvpn/openvpn-status.log\nstatus openvpn-status.log\n# OpenVPN的运行日志，默认为/etc/openvpn/openvpn.log \nlog-append openvpn.log\n# 改成verb 5可以多查看一些调试信息\nverb 5\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])]),n("h1",{attrs:{id:"_4-配置内核和防火墙-启动服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-配置内核和防火墙-启动服务"}},[s._v("#")]),s._v(" 4. 配置内核和防火墙，启动服务")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 开启路由转发功能\nsed -i '/net.ipv4.ip_forward/s/0/1/' /etc/sysctl.conf\nsed -i '/net.ipv4.ip_forward/s/#//' /etc/sysctl.conf\nsysctl -p\n \n# 配置防火墙，别忘记保存\niptables -I INPUT -p tcp --dport 1194 -m comment --comment \"openvpn\" -j ACCEPT\niptables -t nat -A POSTROUTING -s 10.8.0.0/24 -j MASQUERADE\nmkdir /etc/iptables\niptables-save > /etc/iptables/iptables.conf\n# 关闭ufw防火墙，改成iptables，这一步按需要设置，比较ufw在Ubuntu默认关闭的。iptables和ufw任选一个即可。\nufw disable\n \n# 启动openvpn并设置为开机启动\nsystemctl start openvpn@server  \nsystemctl enable openvpn@server  \n# 在systemd单元文件的后面，我们通过指定特定的配置文件名来作为一个实例变量来开启OpenVPN服务，我们的配置文件名称为/etc/openvpn/server.conf，所以我们在systemd单元文件的后面添加@server来开启OpenVPN服务\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("h1",{attrs:{id:"_5-创建客户端配置文件client-ovpn-用于客户端软件使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-创建客户端配置文件client-ovpn-用于客户端软件使用"}},[s._v("#")]),s._v(" 5. 创建客户端配置文件client.ovpn（用于客户端软件使用）")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 复制一份client.conf模板命名为client.ovpn\ncp /usr/share/doc/openvpn/examples/sample-config-files/client.conf /etc/openvpn/client.ovpn  \n\n# 编辑client.ovpn\nvim /etc/openvpn/client.ovpn\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("client\ndev tun # 路由模式\n# 改为tcp\nproto tcp\n# OpenVPN服务器的外网IP和端口\nremote 203.195.1.2 1194\nresolv-retry infinite\nnobind\npersist-key\npersist-tun\nca ca.crt\n# client1的证书\ncert client1.crt\n# client1的密钥\nkey client1.key\nns-cert-type server\n# 去掉前面的注释\ntls-auth ta.key 1\ncomp-lzo\nverb 5\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("ol",{attrs:{start:"6"}},[n("li",[s._v("配置client")])]),s._v(" "),n("p",[s._v("安装软件，可以和服务器安装的保持一致：")]),s._v(" "),n("ul",[n("li",[s._v("/etc/openvpn/client.ovpn")]),s._v(" "),n("li",[s._v("/etc/openvpn/keys/ca.crt")]),s._v(" "),n("li",[s._v("/etc/openvpn/keys/client1.crt")]),s._v(" "),n("li",[s._v("/etc/openvpn/keys/client1.key")]),s._v(" "),n("li",[s._v("/etc/openvpn/keys/ta.key")])]),s._v(" "),n("p",[s._v("将这些文件复制到windows的"),n("code",[s._v("C:\\Users\\kehao\\OpenVPN\\config")]),s._v("下\n然后连接即可")])])}),[],!1,null,null,null);n.default=t.exports}}]);